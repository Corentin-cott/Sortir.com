{# templates/sorties/afficher.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}
    Détail de la sortie | {{ parent() }}
{% endblock %}

{% block body %}
    <div class="body-container">
        <h1 class="title">Détail de la sortie</h1>
        <hr>

        <div class="sortie-grid" style="display: grid; grid-template-columns: 2fr 0.5fr; gap: 1rem; justify-content: center;">

            <!-- Colonne gauche : infos de la sortie -->
            <div class="form-container">
                <div class="container">
                    <div class="row justify-content-center align-items-start g-4">
                        <!-- Image -->
                        <div class="col-12 col-md-4 text-center">
                            {% if sortie.photo %}
                                <img src="{{ asset('uploads/backdrops/' ~ sortie.photo) }}"
                                     alt='alt="Image de la sortie'
                                     class="img-fluid rounded shadow-sm w-100"
                                     style="max-height: 300px; object-fit: cover;"
                                >
                                {% else %}
                                    <img src="https://citygem.app/wp-content/uploads/2024/08/placeholder-1-1.png"
                                         alt="Image de la sortie"
                                         class="img-fluid rounded shadow-sm w-100"
                                         style="max-height: 300px; object-fit: cover;">
                            {% endif %}

                        </div>

                        <!-- Infos principales -->
                        <div class="col-12 col-md-4">
                            <p><strong>Nom :</strong> {{ sortie.nom }}</p>
                            <p><strong>Date et heure de début :</strong> {{ sortie.dateHeureDebut ? sortie.dateHeureDebut|date('d/m/Y H:i') : '' }}</p>
                            <p><strong>Date limite d'inscription :</strong> {{ sortie.dateLimiteInscription ? sortie.dateLimiteInscription|date('d/m/Y H:i') : '' }}</p>
                            <p><strong>Nombre maximum d'inscriptions :</strong> {{ sortie.nbInscriptionMax }}</p>
                            <p><strong>Durée :</strong> {{ sortie.duree }} minutes</p>
                            <p><strong>Description :</strong><br>{{ sortie.descriptionInfos }}</p>
                        </div>

                        <!-- Lieu -->
                        <div class="col-12 col-md-4">
                            <p><strong>Lieu :</strong> {{ sortie.lieu.nom }}</p>
                            <div id="lieu-details">
                                <p>Rue : <span>{{ sortie.lieu.rue }}</span></p>
                                <p>Ville : <span>{{ sortie.lieu.ville.nom }}</span></p>
                                <p>Code postal : <span>{{ sortie.lieu.ville.codePostal }}</span></p>
                                <p>Latitude : <span>{{ sortie.lieu.latitude }}</span></p>
                                <p>Longitude : <span>{{ sortie.lieu.longitude }}</span></p>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: 1.5em 0; margin-top: 2em">

                    <!-- Commentaires -->
                    <section>
                        <h2>Commentaires</h2>

                        {# Formulaire d'ajout de commentaire #}
                        {% if app.user %}
                            <form action="{{ path('app_sortie_ajouter_commentaire', { id: sortie.id }) }}" method="post">
                                <div class="form-group">
                                    <textarea id="contenu" name="contenu" rows="3" required class="form-control" placeholder="Écrivez votre message..."></textarea>
                                </div>
                                <div style="display: flex;">
                                    <button type="submit" class="btn btn-primary mt-2">Publier</button>
                                </div>
                            </form>

                            <hr style="margin: 1.5em 0; margin-top: 2em">
                        {% endif %}

                        {# Liste des commentaires #}
                        {% if sortie.commentaires is not empty %}
                            {% for commentaire in sortie.commentaires %}
                                <article style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px;">

                                    <div style="display: flex; align-items: flex-start; gap: 10px; flex: 1;">
                                        {% set photoUrl = commentaire.participant.photo
                                            ? asset('uploads/photos/' ~ commentaire.participant.photo)
                                            : 'https://avatar.iran.liara.run/public/' ~ commentaire.participant.id ~ '?size=32' %}

                                        <img src="{{ photoUrl }}" alt="Photo de profil" class="profile-photo"
                                             style="width: 58px; height: 58px; border-radius: 50%; object-fit: cover;">

                                        <div>
                                            <p style="margin: 0;">
                                                <strong>{{ commentaire.participant.pseudo }}</strong>
                                                <small style="color: #777;">— {{ commentaire.datePublication|date('d/m/Y H:i') }}</small>
                                            </p>
                                            <p style="margin: 5px 0 0 0;">{{ commentaire.commentaire }}</p>
                                        </div>
                                    </div>

                                    {% if app.user %}
                                        {% if sortie.organisateur.id == app.user.id or commentaire.participant.id == app.user.id or is_granted('ROLE_ADMIN') %}

                                            <form action="{{ path('app_sortie_supprimer_commentaire', {'sortieId': sortie.id, 'commentaireId': commentaire.id}) }}"
                                                  method="post"
                                                  style="margin: 0; display: inline;">
                                                <input type="hidden" name="_token" value="{{ csrf_token('supprimer_commentaire_' ~ commentaire.id) }}">

                                                <button type="submit"
                                                        class="generic-button bouton-danger-color"
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                                        <path fill="#ffffff"
                                                              d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                                                    </svg>
                                                </button>
                                            </form>

                                        {% endif %}
                                    {% endif %}

                                </article>

                            {% endfor %}
                        {% else %}
                            <p>Aucun commentaire sur cette sortie pour le moment.</p>
                        {% endif %}
                    </section>

                </div>
            </div>

            <!-- Colonne droite : liste des participants OU motif -->
            <div class="form-container" style="height: fit-content;">
                <section class="mt-4" style="margin-top: 0 !important;">
                    {% if sortie.etat.libelle == "Annulée" %}
                        <h2>Motif d'annulation</h2>
                        <p style="margin: 0">{{ sortie.annulationMotif }}</p>
                    {% else %}
                        <h2>Participants inscrits ({{ sortie.participants.count() }})</h2>
                        {% if sortie.participants.count() > 0 %}
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered align-middle">
                                    <thead class="table-light">
                                    <tr>
                                        <th>Pseudo</th>
                                        <th>Nom</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for participant in sortie.participants %}
                                        <tr>
                                            <td>
                                                <a href="{{ path('app_edit', {'id': participant.id}) }}" class="text-decoration-none">
                                                    {{ participant.pseudo }}
                                                </a>
                                            </td>
                                            <td>{{ participant.prenom }} {{ participant.nom }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p>Aucun participant d'inscrit pour le moment.</p>
                        {% endif %}
                    {% endif %}
                </section>
            </div>
        </div>
    </div>

    <style>
        .form-container {
            width: auto;
        }

        @media (max-width: 1000px) {
            .sortie-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
{% endblock %}

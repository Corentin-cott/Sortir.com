{# templates/sorties/afficher.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}
    Détail de la sortie | {{ parent() }}
{% endblock %}

{% block body %}
    <div class="body-container">
        <h1 class="title">Détail de la sortie</h1>
        <hr>

        <div class="sortie-grid" style="display: grid; grid-template-columns: 2fr 0.5fr; gap: 1rem; justify-content: center;">

            <!-- Colonne gauche : infos de la sortie -->
            <div class="form-container">
                <div class="container">
                    <div class="row justify-content-center align-items-start g-4">
                        <!-- Image -->
                        <div class="col-12 col-md-4 text-center">
                            {% if sortie.photo %}
                                <img src="{{ asset('uploads/backdrops/' ~ sortie.photo) }}"
                                     alt='alt="Image de la sortie'
                                     class="img-fluid rounded shadow-sm w-100"
                                     style="max-height: 300px; object-fit: cover;"
                                >
                                {% else %}
                                    <img src="https://citygem.app/wp-content/uploads/2024/08/placeholder-1-1.png"
                                         alt="Image de la sortie"
                                         class="img-fluid rounded shadow-sm w-100"
                                         style="max-height: 300px; object-fit: cover;">
                            {% endif %}

                        </div>

                        <!-- Infos principales -->
                        <div class="col-12 col-md-4">
                            <p><strong>Nom :</strong> {{ sortie.nom }}</p>
                            <p><strong>Date et heure de début :</strong> {{ sortie.dateHeureDebut ? sortie.dateHeureDebut|date('d/m/Y H:i') : '' }}</p>
                            <p><strong>Date limite d'inscription :</strong> {{ sortie.dateLimiteInscription ? sortie.dateLimiteInscription|date('d/m/Y H:i') : '' }}</p>
                            <p><strong>Nombre maximum d'inscriptions :</strong> {{ sortie.nbInscriptionMax }}</p>
                            <p><strong>Durée :</strong> {{ sortie.duree }} minutes</p>
                            <p><strong>Description :</strong><br>{{ sortie.descriptionInfos }}</p>
                        </div>

                        <!-- Lieu -->
                        <div class="col-12 col-md-4">
                            <p><strong>Lieu :</strong> {{ sortie.lieu.nom }}</p>
                            <div id="lieu-details">
                                <p>Rue : <span>{{ sortie.lieu.rue }}</span></p>
                                <p>Ville : <span>{{ sortie.lieu.ville.nom }}</span></p>
                                <p>Code postal : <span>{{ sortie.lieu.ville.codePostal }}</span></p>
                                <p>Latitude : <span>{{ sortie.lieu.latitude }}</span></p>
                                <p>Longitude : <span>{{ sortie.lieu.longitude }}</span></p>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: 1.5em 0; margin-top: 2em">

                    <!-- Commentaires -->
                    <section>
                        <h2>Commentaires</h2>

                        {# Formulaire d'ajout de commentaire #}
                        {% if app.user %}
                            <form action="{{ path('app_sortie_ajouter_commentaire', { id: sortie.id }) }}" method="post">
                                <div class="form-group">
                                    <textarea id="contenu" name="contenu" rows="3" required class="form-control" placeholder="Écrivez votre message..."></textarea>
                                </div>
                                <div style="display: flex;">
                                    <button type="submit" class="btn btn-primary mt-2">Publier</button>
                                </div>
                            </form>

                            <hr style="margin: 1.5em 0; margin-top: 2em">
                        {% endif %}

                        {# Liste des commentaires #}
                        {% if sortie.commentaires is not empty %}
                            {% for commentaire in sortie.commentaires %}
                                <article style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px;">

                                    <div style="display: flex; align-items: flex-start; gap: 10px; flex: 1;">
                                        {% set photoUrl = commentaire.participant.photo
                                            ? asset('uploads/photos/' ~ commentaire.participant.photo)
                                            : 'https://avatar.iran.liara.run/public/' ~ commentaire.participant.id ~ '?size=32' %}

                                        <img src="{{ photoUrl }}" alt="Photo de profil" class="profile-photo"
                                             style="width: 58px; height: 58px; border-radius: 50%; object-fit: cover;">

                                        <div>
                                            <p style="margin: 0;">
                                                <strong>{{ commentaire.participant.pseudo }}</strong>
                                                <small style="color: #777;">— {{ commentaire.datePublication|date('d/m/Y H:i') }}</small>
                                            </p>
                                            <p style="margin: 5px 0 0 0;">{{ commentaire.commentaire }}</p>
                                        </div>
                                    </div>

                                    {% if app.user %}
                                        {% if sortie.organisateur.id == app.user.id or commentaire.participant.id == app.user.id or is_granted('ROLE_ADMIN') %}

                                            <form action="{{ path('app_sortie_supprimer_commentaire', {'sortieId': sortie.id, 'commentaireId': commentaire.id}) }}"
                                                  method="post"
                                                  style="margin: 0; display: inline;">
                                                <input type="hidden" name="_token" value="{{ csrf_token('supprimer_commentaire_' ~ commentaire.id) }}">

                                                <button type="submit"
                                                        class="generic-button bouton-danger-color"
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                                        <path fill="#ffffff"
                                                              d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"/>
                                                    </svg>
                                                </button>
                                            </form>

                                        {% endif %}
                                    {% endif %}

                                </article>

                            {% endfor %}
                        {% else %}
                            <p>Aucun commentaire sur cette sortie pour le moment.</p>
                        {% endif %}
                    </section>

                </div>
            </div>

            <!-- Colonne droite : liste des participants OU motif -->
            <div class="form-container" style="height: fit-content;">
                <section class="mt-4" style="margin-top: 0 !important;">
                    {% if sortie.etat.libelle == "Annulée" %}
                        <h2>Motif d'annulation</h2>
                        <p style="margin: 0">{{ sortie.annulationMotif }}</p>
                    {% else %}
                        <h2>Météo prévue pour le {{ sortie.dateHeureDebut|date('d/m/Y H:i') }}</h2>

                        {% if weather %}
                            <p>
                                <svg style="width: 30px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#930101" d="M320 64C267 64 224 107 224 160L224 324.7C194.5 351 176 389.4 176 432C176 511.5 240.5 576 320 576C399.5 576 464 511.5 464 432C464 389.4 445.5 351 416 324.7L416 160C416 107 373 64 320 64zM384 432C384 467.3 355.3 496 320 496C284.7 496 256 467.3 256 432C256 405.1 272.5 382.1 296 372.7L296 216C296 202.7 306.7 192 320 192C333.3 192 344 202.7 344 216L344 372.7C367.5 382.2 384 405.2 384 432z"/></svg>
                                Température : {{ weather.temperature }} °C
                            </p>
                            <p>
                                <svg style="width: 30px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#7da2e3" d="M352 96C352 113.7 366.3 128 384 128L424 128C437.3 128 448 138.7 448 152C448 165.3 437.3 176 424 176L96 176C78.3 176 64 190.3 64 208C64 225.7 78.3 240 96 240L424 240C472.6 240 512 200.6 512 152C512 103.4 472.6 64 424 64L384 64C366.3 64 352 78.3 352 96zM416 448C416 465.7 430.3 480 448 480L480 480C533 480 576 437 576 384C576 331 533 288 480 288L96 288C78.3 288 64 302.3 64 320C64 337.7 78.3 352 96 352L480 352C497.7 352 512 366.3 512 384C512 401.7 497.7 416 480 416L448 416C430.3 416 416 430.3 416 448zM192 576L232 576C280.6 576 320 536.6 320 488C320 439.4 280.6 400 232 400L96 400C78.3 400 64 414.3 64 432C64 449.7 78.3 464 96 464L232 464C245.3 464 256 474.7 256 488C256 501.3 245.3 512 232 512L192 512C174.3 512 160 526.3 160 544C160 561.7 174.3 576 192 576z"/></svg>
                                Vent : {{ weather.wind_speed }} km/h
                            </p>
                            <p>
                                <svg style="width: 30px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#2d6bd7" d="M320 576C214 576 128 490 128 384C128 292.8 258.2 109.9 294.6 60.5C300.5 52.5 309.8 48 319.8 48L320.2 48C330.2 48 339.5 52.5 345.4 60.5C381.8 109.9 512 292.8 512 384C512 490 426 576 320 576zM240 376C240 362.7 229.3 352 216 352C202.7 352 192 362.7 192 376C192 451.1 252.9 512 328 512C341.3 512 352 501.3 352 488C352 474.7 341.3 464 328 464C279.4 464 240 424.6 240 376z"/></svg>
                                Précipitations : {{ weather.precipitation }} mm
                            </p>
                            <p>
                                <svg style="width: 30px"xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#ffae00" d="M210.2 53.9C217.6 50.8 226 51.7 232.7 56.1L320.5 114.3L408.3 56.1C415 51.7 423.4 50.9 430.8 53.9C438.2 56.9 443.4 63.5 445 71.3L465.9 174.5L569.1 195.4C576.9 197 583.5 202.4 586.5 209.7C589.5 217 588.7 225.5 584.3 232.2L526.1 320L584.3 407.8C588.7 414.5 589.5 422.9 586.5 430.3C583.5 437.7 576.9 443.1 569.1 444.6L465.8 465.4L445 568.7C443.4 576.5 438 583.1 430.7 586.1C423.4 589.1 414.9 588.3 408.2 583.9L320.4 525.7L232.6 583.9C225.9 588.3 217.5 589.1 210.1 586.1C202.7 583.1 197.3 576.5 195.8 568.7L175 465.4L71.7 444.5C63.9 442.9 57.3 437.5 54.3 430.2C51.3 422.9 52.1 414.4 56.5 407.7L114.7 320L56.5 232.2C52.1 225.5 51.3 217.1 54.3 209.7C57.3 202.3 63.9 196.9 71.7 195.4L175 174.6L195.9 71.3C197.5 63.5 202.9 56.9 210.2 53.9zM239.6 320C239.6 275.6 275.6 239.6 320 239.6C364.4 239.6 400.4 275.6 400.4 320C400.4 364.4 364.4 400.4 320 400.4C275.6 400.4 239.6 364.4 239.6 320zM448.4 320C448.4 249.1 390.9 191.6 320 191.6C249.1 191.6 191.6 249.1 191.6 320C191.6 390.9 249.1 448.4 320 448.4C390.9 448.4 448.4 390.9 448.4 320z"/></svg>
                                Code météo : {{ weather.description }}
                            </p>
                        {% else %}
                            <p>Aucune donnée météo disponible pour cette date.</p>
                        {% endif %}
                        <h2>Participants inscrits ({{ sortie.participants.count() }})</h2>
                        {% if sortie.participants.count() > 0 %}
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered align-middle">
                                    <thead class="table-light">
                                    <tr>
                                        <th>Pseudo</th>
                                        <th>Nom</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for participant in sortie.participants %}
                                        <tr>
                                            <td>
                                                <a href="{{ path('app_edit', {'id': participant.id}) }}" class="text-decoration-none">
                                                    {{ participant.pseudo }}
                                                </a>
                                            </td>
                                            <td>{{ participant.prenom }} {{ participant.nom }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p>Aucun participant d'inscrit pour le moment.</p>
                        {% endif %}

                    {% endif %}
                </section>
            </div>
        </div>

    </div>

    <style>
        .form-container {
            width: auto;
        }

        @media (max-width: 1000px) {
            .sortie-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
{% endblock %}
